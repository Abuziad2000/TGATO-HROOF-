import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  doc, 
  onSnapshot, 
  setDoc, 
  collection, 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/firestore';

// إعدادات قاعدة البيانات السحابية
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'latti-app-v3';

export default function App() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('home');
  const [isAdmin, setIsAdmin] = useState(false);
  const [adminPassword, setAdminPassword] = useState("");
  
  // البيانات القابلة للتعديل
  const [data, setData] = useState({
    bank: {
      accountNumber: "52067764",
      accountName: "العباس إدريس علي إدريس",
      bankName: "بنك فيصل الإسلامي"
    },
    news: [
      { id: 1, title: "إدارة لتي", text: "تم البدء في مشروع الإنارة"، time: "الآن", icon: "fa-bullhorn" },
      { id: 2, title: "اجتماع", text: "اجتماع شباب المنطقة اليوم", time: "أمس", icon: "fa-users" }
    ],
    patients: [
      { id: 1, name: "حالة (م.ع)", target: 500000, current: 150000 },
      { id: 2, name: "عملية عاجلة", target: 800000, current: 200000 }
    ],
    services: [
      { id: 1, name: "ترميم الطرق", progress: 60, status: "جاري العمل" },
      { id: 2, name: "الكهرباء", progress: 30, status: "مرحلة 1" }
    ]
  });

  // 1. المصادقة التلقائية
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. جلب البيانات من السحابة وتحديثها لحظياً
  useEffect(() => {
    if (!user) return;
    const docRef = doc(db, 'artifacts', appId, 'public', 'mainData');
    const unsub = onSnapshot(docRef, (snap) => {
      if (snap.exists()) {
        setData(snap.data());
      } else {
        // إذا كانت أول مرة، نرفع البيانات الافتراضية
        setDoc(docRef, data);
      }
    }, (err) => console.error("Firestore Error:", err));
    return () => unsub();
  }, [user]);

  // 3. وظيفة حفظ التعديلات للسحابة
  const saveData = async (newData) => {
    if (!user) return;
    try {
      await setDoc(doc(db, 'artifacts', appId, 'public', 'mainData'), newData);
      alert("✅ تم تحديث التطبيق عند الجميع بنجاح!");
    } catch (e) {
      alert("❌ حدث خطأ أثناء الحفظ");
    }
  };

  // وظائف لوحة التحكم
  const updateBank = (field, value) => {
    const newData = { ...data, bank: { ...data.bank, [field]: value } };
    setData(newData);
  };

  const updateNews = (index, field, value) => {
    const newNews = [...data.news];
    newNews[index][field] = value;
    setData({ ...data, news: newNews });
  };

  const deleteNews = (index) => {
    const newNews = data.news.filter((_, i) => i !== index);
    setData({ ...data, news: newNews });
  };

  const addNews = () => {
    const newNews = [...data.news, { id: Date.now(), title: "عنوان جديد", text: "نص الخبر هنا", time: "الآن", icon: "fa-newspaper" }];
    setData({ ...data, news: newNews });
  };

  const updatePatient = (index, field, value) => {
    const newPatients = [...data.patients];
    newPatients[index][field] = field === 'name' ? value : Number(value);
    setData({ ...data, patients: newPatients });
  };

  if (!user) return <div className="flex items-center justify-center h-screen font-bold">جاري التحميل...</div>;

  return (
    <div className="min-h-screen bg-[#f8fafc] text-right pb-28 font-sans" dir="rtl">
      
      {/* الهيدر الثابت */}
      <header className="bg-[#064e3b] text-white pt-10 pb-6 px-6 rounded-b-[2.5rem] shadow-xl sticky top-0 z-50">
        <div className="flex justify-between items-center">
          <div>
            <h1 className="text-2xl font-black">لتي قسم 2 شرق</h1>
            <p className="text-[11px] opacity-70">إدارة: العباس إدريس</p>
          </div>
          <button onClick={() => setActiveTab('admin')} className="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center border border-white/20">
            <i className={`fas ${isAdmin ? 'fa-user-shield text-yellow-400' : 'fa-lock'}`}></i>
          </button>
        </div>
      </header>

      <main className="p-5">
        
        {/* قسم الرئيسية */}
        {activeTab === 'home' && (
          <div className="animate-in fade-in duration-500">
            {/* بطاقة البنك */}
            <div className="bg-gradient-to-br from-slate-900 to-blue-900 text-white p-6 rounded-[2rem] shadow-2xl mb-8 relative overflow-hidden">
                <div className="flex justify-between items-start mb-6">
                    <div>
                        <p className="text-[10px] text-blue-200 mb-1">بيانات التحويل</p>
                        <h3 className="font-black text-lg">{data.bank.bankName}</h3>
                    </div>
                    <i className="fas fa-university text-2xl opacity-50"></i>
                </div>
                <div className="mb-6">
                    <p className="text-[10px] text-blue-200 mb-1">رقم الحساب</p>
                    <div onClick={() => {navigator.clipboard.writeText(data.bank.accountNumber); alert('تم النسخ')}} className="flex items-center gap-3 bg-black/20 p-3 rounded-xl w-fit cursor-pointer">
                        <span className="text-2xl font-mono font-black tracking-widest">{data.bank.accountNumber}</span>
                        <i className="fas fa-copy text-sm opacity-50"></i>
                    </div>
                </div>
                <div className="border-t border-white/20 pt-4">
                    <p className="text-[10px] text-blue-200 italic">صاحب الحساب: {data.bank.accountName}</p>
                </div>
            </div>

            {/* الأخبار */}
            <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i className="fas fa-newspaper text-green-700"></i> أخبار المنطقة
            </h3>
            <div className="space-y-3">
              {data.news.map((item) => (
                <div key={item.id} className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex gap-3">
                  <div className="w-10 h-10 bg-green-50 text-green-600 rounded-full flex items-center justify-center shrink-0">
                    <i className={`fas ${item.icon}`}></i>
                  </div>
                  <div>
                    <p className="text-xs font-black text-gray-800">{item.title} <span className="text-[9px] text-gray-400 font-normal mr-1">{item.time}</span></p>
                    <p className="text-sm text-gray-600 mt-1">{item.text}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* قسم التكافل */}
        {activeTab === 'takaful' && (
          <div className="space-y-6 animate-in fade-in">
            <h2 className="text-xl font-black text-gray-800">الحالات الإنسانية</h2>
            {data.patients.map((p, i) => (
              <div key={p.id} className="bg-white p-5 rounded-[2rem] border border-gray-100 shadow-sm">
                <div className="flex justify-between items-center mb-3">
                  <h4 className="font-bold text-gray-800">{p.name}</h4>
                  <span className="text-red-600 bg-red-50 px-3 py-1 rounded-full text-[10px] font-bold">باقي: {(p.target - p.current).toLocaleString()} ج</span>
                </div>
                <div className="w-full h-3 bg-gray-100 rounded-full overflow-hidden">
                  <div className="h-full bg-red-500 transition-all duration-1000" style={{ width: `${(p.current / p.target) * 100}%` }}></div>
                </div>
                <div className="flex justify-between mt-2 text-[10px] text-gray-400">
                  <span>المجموع: {p.target.toLocaleString()}</span>
                  <span>المجمع: {p.current.toLocaleString()}</span>
                </div>
              </div>
            ))}
          </div>
        )}

        {/* لوحة التحكم (المشرف فقط) */}
        {activeTab === 'admin' && (
          <div className="animate-in slide-in-from-bottom duration-500">
            {!isAdmin ? (
              <div className="bg-white p-8 rounded-[2.5rem] shadow-xl text-center mt-10">
                <i className="fas fa-shield-alt text-4xl text-gray-200 mb-4"></i>
                <h3 className="font-bold text-lg mb-6">دخول المشرف</h3>
                <input 
                  type="password" 
                  placeholder="كلمة السر (2510)" 
                  className="w-full p-4 bg-gray-50 rounded-2xl text-center mb-4 border outline-none"
                  onChange={(e) => setAdminPassword(e.target.value)}
                />
                <button 
                  onClick={() => adminPassword === "2510" ? setIsAdmin(true) : alert("خطأ")} 
                  className="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold"
                >دخول</button>
              </div>
            ) : (
              <div className="space-y-8 pb-10">
                <div className="flex justify-between items-center bg-green-100 p-4 rounded-2xl">
                    <span className="font-bold text-green-800">وضع التعديل نشط</span>
                    <button onClick={() => saveData(data)} className="bg-green-600 text-white px-6 py-2 rounded-xl font-bold text-sm shadow-lg">حفظ التغييرات للجميع</button>
                </div>

                {/* تعديل البنك */}
                <div className="bg-white p-6 rounded-[2rem] border shadow-sm">
                    <h4 className="font-bold mb-4 border-b pb-2">تعديل بيانات البنك</h4>
                    <label className="text-xs text-gray-400">اسم البنك</label>
                    <input className="w-full p-3 bg-gray-50 rounded-xl mb-3 border" value={data.bank.bankName} onChange={(e) => updateBank('bankName', e.target.value)} />
                    <label className="text-xs text-gray-400">رقم الحساب</label>
                    <input className="w-full p-3 bg-gray-50 rounded-xl mb-3 border" value={data.bank.accountNumber} onChange={(e) => updateBank('accountNumber', e.target.value)} />
                    <label className="text-xs text-gray-400">اسم صاحب الحساب</label>
                    <input className="w-full p-3 bg-gray-50 rounded-xl border" value={data.bank.accountName} onChange={(e) => updateBank('accountName', e.target.value)} />
                </div>

                {/* إدارة الأخبار */}
                <div className="bg-white p-6 rounded-[2rem] border shadow-sm">
                    <div className="flex justify-between mb-4 border-b pb-2">
                        <h4 className="font-bold">إدارة الأخبار</h4>
                        <button onClick={addNews} className="text-blue-600 text-xs font-bold">+ إضافة خبر</button>
                    </div>
                    {data.news.map((n, i) => (
                        <div key={n.id} className="p-4 bg-gray-50 rounded-xl mb-4 relative">
                            <button onClick={() => deleteNews(i)} className="absolute left-2 top-2 text-red-400 text-xs">حذف</button>
                            <input className="w-full bg-transparent font-bold text-sm mb-1 outline-none" value={n.title} onChange={(e) => updateNews(i, 'title', e.target.value)} />
                            <textarea className="w-full bg-transparent text-xs outline-none" rows="2" value={n.text} onChange={(e) => updateNews(i, 'text', e.target.value)} />
                        </div>
                    ))}
                </div>

                {/* إدارة الحالات */}
                <div className="bg-white p-6 rounded-[2rem] border shadow-sm">
                    <h4 className="font-bold mb-4 border-b pb-2">تعديل حالات التكافل</h4>
                    {data.patients.map((p, i) => (
                        <div key={p.id} className="p-4 border-b last:border-0">
                            <input className="font-bold text-sm w-full mb-2" value={p.name} onChange={(e) => updatePatient(i, 'name', e.target.value)} />
                            <div className="flex gap-2">
                                <div className="flex-1">
                                    <label className="text-[10px] text-gray-400">المطلوب</label>
                                    <input type="number" className="w-full p-2 bg-gray-50 rounded" value={p.target} onChange={(e) => updatePatient(i, 'target', e.target.value)} />
                                </div>
                                <div className="flex-1">
                                    <label className="text-[10px] text-gray-400">المجمع حالياً</label>
                                    <input type="number" className="w-full p-2 bg-gray-50 rounded" value={p.current} onChange={(e) => updatePatient(i, 'current', e.target.value)} />
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
              </div>
            )}
          </div>
        )}

      </main>

      {/* الملاحة السفلية */}
      <nav className="fixed bottom-6 left-6 right-6 h-20 bg-white/90 backdrop-blur-md rounded-[2.5rem] shadow-2xl flex justify-around items-center px-4 border border-white/50 z-40">
        <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1 ${activeTab === 'home' ? 'text-green-700' : 'text-gray-400'}`}>
            <i className="fas fa-home text-xl"></i>
            <span className="text-[9px] font-bold">الرئيسية</span>
        </button>
        <button onClick={() => setActiveTab('takaful')} className={`flex flex-col items-center gap-1 ${activeTab === 'takaful' ? 'text-green-700' : 'text-gray-400'}`}>
            <i className="fas fa-hand-holding-heart text-xl"></i>
            <span className="text-[9px] font-bold">تكافل</span>
        </button>
        <button onClick={() => setActiveTab('admin')} className={`flex flex-col items-center gap-1 ${activeTab === 'admin' ? 'text-green-700' : 'text-gray-400'}`}>
            <i className="fas fa-cog text-xl"></i>
            <span className="text-[9px] font-bold">الإعدادات</span>
        </button>
      </nav>

    </div>
  );
}

